<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>quiz</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
          #quiz {max-width:660px; margin:0 auto; color:#2F2F2F; border: 2px solid black; padding:0.5rem; overflow-y:auto;}

          #previous-question {float:left; margin:0.5rem; padding: 0.5rem; display:none;}
          #next-question {float:right; margin: 0.5rem; padding:0.5rem; display:none;}

          .questions {overflow-y:auto; margin:1rem 0 0 0; display:none;}

          .question {margin:0;}
          .question .number {font-size:2em;}

          .main {width:65%; float: left;}

          .meta {width:32%; float:right;}
          .meta img {width:100%; height:auto;}
          .meta .answer-details {display:none;}

          .options {list-style-type: none; margin:0; padding:0;}
          .option {padding:0.5rem 0.5rem 0.5rem 0; margin:0.75rem 0 0 1rem; position:relative; border-radius: 5px; border: 1px solid #2f2f2f; text-align: center;}
          .option:hover {cursor:pointer;}
          .answered .option:hover {cursor:default;}

          .option .key {text-transform:uppercase;}

          .answered .correct {background:#07D073;}
          .answered .incorrect {background:#FF5A5B;}
        </style>
    </head>
    <body>
        <div id="quiz"></div>
        <script src="questions.js"></script>
        <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> -->
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore.js"></script>
        <!--
        TEMPLATE: question
        -->
        <script id="questions-template" type="text/template">
          <div class="questions">
            <div class="main">
              <h5 class="question"><span class="number"><%= number %></span><%= question %></h5>
              <ul class="options">
                <% _.each(options, function(value, key){ %>
                  <li class="option<% if(key === answer) print(' correct') %>">
                    <span class="key"><%= key %>: </span>
                    <span class="value"><%= value %></span>
                  </li>
                <% }) %>
              </ul>
            </div>
            <div class="meta">
              <%= imgsrc !== '' ? '<img src="' + imgsrc + '">' : '' %>
              <div class="answer-details">
                <%= answerDetails %>
                <a href="<%= articleUrl %>">Read more</a>
              </div>
            <div>
          </div>
        </script>
        <script>  // browser >= ie9
          var quiz = document.getElementById('quiz');

          // render questions
          var template = _.template(document.getElementById('questions-template').innerHTML);
          _.each(questionsArray, function(question){
            quiz.innerHTML = quiz.innerHTML + template(question);
          });

          //prev/next btns
          quiz.innerHTML = quiz.innerHTML + '<button id="previous-question">Previous question</button><button id="next-question">Next question</button>';
          var next = document.getElementById('next-question');
          var prev = document.getElementById('previous-question');

          //question state
          var questions = document.getElementsByClassName('questions');
          var currentQuestion = 0;

          //show next button for first question
          next.style.display = 'block';

          //next question
          next.addEventListener('click', function(){
            questions[currentQuestion].style.display = "none";
            currentQuestion++;
            questions[currentQuestion].style.display = 'block';

            //check for existing answer
            if(loadAnswer(currentQuestion)) {
              var opts = document.getElementsByClassName("options")[currentQuestion];
              var el;
              var ans = loadAnswer(currentQuestion);
              _.each(opts.getElementsByClassName("option"), function(opt) {
                var key = opt.getElementsByClassName('key')[0].textContent.charAt(0);
                if (key === ans) {
                  el = opt;
                }
              });
              try {
                markAnswers(el, true);
              } catch (err) {
                console.log(err);
              }
            }
            
            //toggle prev/next btns
            if (currentQuestion === 0) {
              prev.style.display = 'none';
              next.style.display = 'block';
            } else if (currentQuestion > 0 && currentQuestion < (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'block';
            } else if (currentQuestion === (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'none';
            }
          });

          //prev question
          prev.addEventListener('click', function(){
            questions[currentQuestion].style.display = "none";
            currentQuestion--;
            questions[currentQuestion].style.display = 'block';

            //check for existing answer
            if(loadAnswer(currentQuestion)) {
              var opts = document.getElementsByClassName("options")[currentQuestion];
              var el;
              var ans = loadAnswer(currentQuestion);
              _.each(opts.getElementsByClassName("option"), function(opt) {
                var key = opt.getElementsByClassName('key')[0].textContent.charAt(0);
                if (key === ans) {
                  el = opt;
                }
              });
              try {
                markAnswers(el, true);
              } catch (err) {
                console.log(err);
              }
            }

            //toggle prev/next btns
            if (currentQuestion === 0) {
              prev.style.display = 'none';
              next.style.display = 'block';
            } else if (currentQuestion > 0 && currentQuestion < (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'block';
            } else if (currentQuestion === (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'none';
            }
          });

          //store answers in localstorage
          function storeAnswer(num,ans) {
            var data = {};
            if (localStorage.getItem('answers')) {
              data = JSON.parse(localStorage.getItem('answers'));
            }
            data[num] = ans;
            localStorage.setItem('answers',JSON.stringify(data));
          }

          //retrieve answers from localstorage
          function loadAnswer(num) {
            var data = {};
            if (localStorage.getItem('answers')) {
              data = JSON.parse(localStorage.getItem('answers'));
              if(data[num]){
                return data[num];
              } else {
                return false;
              }
            } else {
              return false;
            }
          }

          //mark answer
          function markAnswers(el, review){
            //get element of question
            var el = el;
            var parent = el.parentElement;
            var more = parent.parentElement.parentElement.getElementsByClassName('answer-details')[0];

            //store answer
            if (!review) {
              var ans = el.getElementsByClassName('key')[0].textContent.charAt(0);
              storeAnswer(currentQuestion,ans);
            }
            //show answer details
            more.style.display = 'block';

            //mark answers
            if (parent.className.indexOf('answered') === -1) {
              parent.className += ' answered';
              if (el.className.indexOf('correct') === -1) {
                el.className += ' incorrect';
              }
            }
          }

          // apply quiz functionality to each set of options
          var options = document.getElementsByClassName('option');
          _.each(options,function(option) {

            //add click event to each option
            option.addEventListener('click', function(){
              markAnswers(this,false);
            });
          });

          //display first question
          quiz.getElementsByClassName('questions')[0].style.display = 'block';
          if(loadAnswer(currentQuestion)) {
            var opts = document.getElementsByClassName("options")[currentQuestion];
            var el;
            var ans = loadAnswer(currentQuestion);
            _.each(opts.getElementsByClassName("option"), function(opt) {
              var key = opt.getElementsByClassName('key')[0].textContent.charAt(0);
              if (key === ans) {
                el = opt;
              }
            });
            try {
              markAnswers(el, true);
            } catch (err) {
              console.log(err);
            }
          }
        </script>
    </body>
</html>
