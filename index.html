<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>quiz</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
          #quiz {max-width:660px; margin:0 auto; color:#2F2F2F; border: 1px solid black; border-radius:5px; padding:0.75rem; overflow-y:auto; font-family:Georgia, 'Times New Roman', Times, serif;}

          .button {outline:none; border:0; margin:1rem 0 0 0; padding:0.5rem 1rem; color:#444; text-transform:uppercase; font-size:1rem; border-radius:5px;}
          .button:hover {cursor:pointer;}

          #previous-question {float:left; display:none; background:lightblue;}
          #next-question {float:right; display:none; background:lightblue; color:azure;}

          .questions {overflow-y:auto; display:none;}

          .question {margin:0 0 0 10%; font-size:1.25rem; line-height:1.25rem; font-weight:normal;}
          .number {font-size:1.5rem; line-height:1.25rem; font-weight:bold; float:left;}

          .main {width:65%; float:left; }

          .meta {width:32%; float:right;}
          .meta img {width:100%; height:auto;}
          .meta .answer-details {opacity:0; transition: opacity 0.7s ease;}

          .options {list-style-type: none; margin:0 0 0 10%; padding:0; font-family:Verdana, Arial, Helvetica, sans-serif;}
          .option {padding:0.5rem 0; margin:0.75rem 0 0 0; border-radius: 5px; border: 1px solid #2f2f2f; text-align: center;}
          .option:hover {cursor:pointer;}
          .answered .option:hover {cursor:default;}

          .option .key {text-transform:uppercase;}

          .answered .correct {transition:background-color 0.7s; background:palegreen;}
          .answered .incorrect {transition:background-color 0s; background:lightcoral;}

          @media (max-width: 480px) {
            .main {float: none; width:100%;}
            .meta {float: none; width:100%; margin-top:1rem;}
            .options {margin-left:0;}
            #previous-question, #next-question {float:none; width:100%;}
          }


        </style>
    </head>
    <body>
        <div id="quiz"></div>
        <script src="questions.js"></script>
        <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> -->
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore.js"></script>
        <!--
        TEMPLATE: question
        -->
        <script id="questions-template" type="text/template">
          <div class="questions">
            <div class="main">
              <span class="number"><%= number %>.</span>
              <h5 class="question"><%= question %></h5>
              <ul class="options">
                <% _.each(options, function(value, key){ %>
                  <li class="option<% if(key === answer) print(' correct') %>">
                    <span class="key"><%= key %>: </span>
                    <span class="value"><%= value %></span>
                  </li>
                <% }) %>
              </ul>
            </div>
            <div class="meta">
              <%= imgsrc !== '' ? '<img src="' + imgsrc + '">' : '' %>
              <div class="answer-details">
                <%= answerDetails %>
                <a href="<%= articleUrl %>">Read more</a>
              </div>
            <div>
          </div>
        </script>
        <script>  // browser >= ie9
          var quizID = 1234;  //clickability ID
          var quiz = document.getElementById('quiz');

          // render questions
          var template = _.template(document.getElementById('questions-template').innerHTML);
          _.each(questionsArray, function(question){
            quiz.innerHTML = quiz.innerHTML + template(question);
          });

          //prev/next btns
          quiz.innerHTML = quiz.innerHTML + '<button id="next-question" class="button">Next question</button><button id="previous-question" class="button">Previous question</button>';
          var next = document.getElementById('next-question');
          var prev = document.getElementById('previous-question');

          //question state
          var questions = document.getElementsByClassName('questions');
          var currentQuestion = 0;

          //show next button for first question
          next.style.display = 'block';

          //next question
          next.addEventListener('click', function(){
            questions[currentQuestion].style.display = "none";
            currentQuestion++;
            next.style.color = '';
            questions[currentQuestion].style.display = 'block';

            //check for existing answer
            if(loadAnswer(currentQuestion)) {
              var opts = document.getElementsByClassName("options")[currentQuestion];
              var el;
              var ans = loadAnswer(currentQuestion);
              _.each(opts.getElementsByClassName("option"), function(opt) {
                var key = opt.getElementsByClassName('key')[0].textContent.charAt(0);
                if (key === ans) {
                  el = opt;
                }
              });
              try {
                markAnswers(el, true);
              } catch (err) {
                console.log(err);
              }
            }

            //toggle prev/next btns
            if (currentQuestion === 0) {
              prev.style.display = 'none';
              next.style.display = 'block';
            } else if (currentQuestion > 0 && currentQuestion < (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'block';
            } else if (currentQuestion === (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'none';
            }
          });

          //prev question
          prev.addEventListener('click', function(){
            questions[currentQuestion].style.display = "none";
            currentQuestion--;
            questions[currentQuestion].style.display = 'block';

            //check for existing answer
            if(loadAnswer(currentQuestion)) {
              var opts = document.getElementsByClassName("options")[currentQuestion];
              var el;
              var ans = loadAnswer(currentQuestion);
              _.each(opts.getElementsByClassName("option"), function(opt) {
                var key = opt.getElementsByClassName('key')[0].textContent.charAt(0);
                if (key === ans) {
                  el = opt;
                }
              });
              try {
                markAnswers(el, true);
              } catch (err) {
                console.log(err);
              }
            }

            //toggle prev/next btns
            if (currentQuestion === 0) {
              prev.style.display = 'none';
              next.style.display = 'block';
            } else if (currentQuestion > 0 && currentQuestion < (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'block';
            } else if (currentQuestion === (questions.length - 1)) {
              prev.style.display = 'block';
              next.style.display = 'none';
            }
          });

          //store answers in localstorage
          function storeAnswer(num,ans) {
            var data = {};
            if (localStorage.getItem('answers-' + quizID)) {
              data = JSON.parse(localStorage.getItem('answers-' + quizID));
            }
            data[num] = ans;
            localStorage.setItem('answers-' + quizID,JSON.stringify(data));
          }

          //retrieve answers from localstorage
          function loadAnswer(num) {
            var data = {};
            if (localStorage.getItem('answers-' + quizID)) {
              data = JSON.parse(localStorage.getItem('answers-' + quizID));
              if(data[num]){
                return data[num];
              } else {
                return false;
              }
            } else {
              return false;
            }
          }

          //mark answer
          function markAnswers(el, review){
            //get element of question
            var el = el;
            var parent = el.parentElement;
            var more = parent.parentElement.parentElement.getElementsByClassName('answer-details')[0];

            //store answer
            if (!review) {
              var ans = el.getElementsByClassName('key')[0].textContent.charAt(0);
              storeAnswer(currentQuestion,ans);
            }
            //show answer details
            more.style.opacity = 1;
            next.style.color = '#2F2F2F';

            //mark answers
            if (parent.className.indexOf('answered') === -1) {
              parent.className += ' answered';
              if (el.className.indexOf('correct') === -1) {
                el.className += ' incorrect';
              }
            }
          }

          // apply quiz functionality to each set of options
          var options = document.getElementsByClassName('option');
          _.each(options,function(option) {

            //add click event to each option
            option.addEventListener('click', function(){
              markAnswers(this,false);
            });
          });

          //display first question
          quiz.getElementsByClassName('questions')[0].style.display = 'block';
          if(loadAnswer(currentQuestion)) {
            var opts = document.getElementsByClassName("options")[currentQuestion];
            var el;
            var ans = loadAnswer(currentQuestion);
            _.each(opts.getElementsByClassName("option"), function(opt) {
              var key = opt.getElementsByClassName('key')[0].textContent.charAt(0);
              if (key === ans) {
                el = opt;
              }
            });
            try {
              markAnswers(el, true);
            } catch (err) {
              console.log(err);
            }
          }
        </script>
    </body>
</html>
